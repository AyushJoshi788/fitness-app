// BACKEND_DATA_MODEL.md

# Backend Data Model for FitAI

## üóÑÔ∏è Firestore Database Schema

### Collection Structure

```
firestore-database/
‚îú‚îÄ‚îÄ users/
‚îÇ   ‚îî‚îÄ‚îÄ {userId}/
‚îÇ       ‚îú‚îÄ‚îÄ profile data
‚îÇ       ‚îú‚îÄ‚îÄ subscription/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ status data
‚îÇ       ‚îî‚îÄ‚îÄ workouts/
‚îÇ           ‚îú‚îÄ‚îÄ {workoutId1}/
‚îÇ           ‚îî‚îÄ‚îÄ {workoutId2}/
‚îÇ
‚îú‚îÄ‚îÄ exercises/
‚îÇ   ‚îî‚îÄ‚îÄ {exerciseId}/
‚îÇ       ‚îî‚îÄ‚îÄ exercise catalog
‚îÇ
‚îî‚îÄ‚îÄ audit_logs/
    ‚îî‚îÄ‚îÄ {auditId}/
        ‚îî‚îÄ‚îÄ weekly reviews
```

---

## üë§ Users Collection

**Path:** `/users/{userId}`

```typescript
interface User {
  // Basics
  id: string;                    // Firebase UID (auto)
  email: string;
  displayName: string;
  photoURL?: string;
  createdAt: Timestamp;
  
  // Profile
  ageGroup: 'teen' | 'young-adult' | 'adult' | 'senior';
  fitnessLevel: 'beginner' | 'intermediate' | 'advanced';
  goal: 'weight-loss' | 'muscle-gain' | 'endurance' | 'general-fitness';
  
  // Physical data for AI
  weight_kg?: number;
  height_cm?: number;
  gender?: 'M' | 'F' | 'Other';
  
  // Subscription
  subscriptionStatus: 'free' | 'premium';
  premiumExpiresAt?: Timestamp;
  premiumActivatedAt?: Timestamp;
  
  // Settings
  preferredLanguage: string;
  timezone: string;
  notificationsEnabled: boolean;
  
  // Tracking
  lastWorkoutDate?: Timestamp;
  totalWorkouts: number;
  totalHours: number;
}
```

### Firestore Document Example
```json
{
  "id": "user_123abc",
  "email": "john@gmail.com",
  "displayName": "John Doe",
  "createdAt": "2026-01-19T10:00:00Z",
  "ageGroup": "young-adult",
  "fitnessLevel": "beginner",
  "goal": "weight-loss",
  "weight_kg": 85,
  "height_cm": 180,
  "subscriptionStatus": "free",
  "totalWorkouts": 5,
  "totalHours": 2.5
}
```

---

## üí™ Workouts Subcollection

**Path:** `/users/{userId}/workouts/{workoutId}`

```typescript
interface Exercise {
  exerciseId: string;
  name: string;
  targetMuscles: string[];      // ['chest', 'triceps']
  sets: number;
  reps: number;
  weight_kg?: number;
  duration_mins?: number;
  notes?: string;
}

interface Workout {
  // Metadata
  id: string;                    // Auto-generated by Firestore
  userId: string;
  date: Timestamp;
  duration_mins: number;
  
  // Session data
  exercises: Exercise[];
  totalSets: number;
  totalReps: number;
  
  // Rating & feedback
  difficulty: 1 | 2 | 3 | 4 | 5;
  energyLevel: 1 | 2 | 3 | 4 | 5;
  mood: string;
  painPoints?: string[];
  
  // AI Analysis (auto-generated)
  formQualityScore?: 0-100;
  progressiveOverloadStatus?: 'good' | 'stagnant' | 'excessive';
  injuryRiskFlags?: string[];
  
  // Timestamps
  createdAt: Timestamp;
  updatedAt: Timestamp;
}
```

### Example Firestore Document
```json
{
  "id": "workout_123",
  "userId": "user_123abc",
  "date": "2026-01-19T14:30:00Z",
  "duration_mins": 45,
  "exercises": [
    {
      "exerciseId": "ex_bench",
      "name": "Bench Press",
      "targetMuscles": ["chest", "triceps"],
      "sets": 4,
      "reps": 8,
      "weight_kg": 100,
      "notes": "Good form, full ROM"
    },
    {
      "exerciseId": "ex_squat",
      "name": "Barbell Squat",
      "targetMuscles": ["quadriceps", "glutes"],
      "sets": 4,
      "reps": 10,
      "weight_kg": 120
    }
  ],
  "totalSets": 8,
  "difficulty": 4,
  "energyLevel": 5,
  "formQualityScore": 85,
  "progressiveOverloadStatus": "good"
}
```

---

## üèãÔ∏è Exercise Catalog Collection

**Path:** `/exercises/{exerciseId}`

```typescript
interface ExerciseCatalog {
  id: string;
  name: string;
  category: 'strength' | 'cardio' | 'flexibility' | 'functional';
  targetMuscles: string[];
  
  // Form guidelines
  properForm: string[];          // ["Keep chest up", "Full range of motion"]
  commonMistakes: string[];
  videoUrl?: string;
  
  // Progression
  beginnerWeight_kg: number;
  progressionIncrement: number;
  
  // Safety
  injuryWarnings?: string[];
  contraindications?: string[];
  
  // Metadata
  difficulty: 'easy' | 'medium' | 'hard';
  equipment: string[];
}
```

### Example
```json
{
  "id": "ex_bench",
  "name": "Barbell Bench Press",
  "category": "strength",
  "targetMuscles": ["chest", "triceps", "anterior_deltoid"],
  "properForm": [
    "Feet flat on ground",
    "Lower bar to chest",
    "Full extension at top",
    "Controlled descent"
  ],
  "commonMistakes": [
    "Bouncing bar off chest",
    "Partial range of motion",
    "Elbows flared too wide"
  ],
  "beginnerWeight_kg": 20,
  "progressionIncrement": 5,
  "difficulty": "easy",
  "equipment": ["Barbell", "Bench"]
}
```

---

## üìä Subscription Collection

**Path:** `/subscriptions/{subscriptionId}`

```typescript
interface Subscription {
  id: string;
  userId: string;
  
  // Plan details
  planType: 'free' | 'monthly' | 'yearly';
  amount_usd: number;
  currency: 'USD' | 'INR' | 'EUR';
  
  // Payment
  paymentMethod: 'razorpay' | 'stripe' | 'qr_demo';
  transactionId: string;
  paymentStatus: 'pending' | 'completed' | 'failed' | 'refunded';
  
  // Validity
  activatedAt: Timestamp;
  expiresAt: Timestamp;
  autoRenew: boolean;
  
  // QR Demo Specific
  isQrDemo?: boolean;
  qrDemoCode?: string;
  qrDemoUsedAt?: Timestamp;
  
  // Metadata
  createdAt: Timestamp;
  updatedAt: Timestamp;
}
```

### Example
```json
{
  "id": "sub_456",
  "userId": "user_123abc",
  "planType": "monthly",
  "amount_usd": 4.99,
  "currency": "USD",
  "paymentMethod": "razorpay",
  "transactionId": "razorpay_123xyz",
  "paymentStatus": "completed",
  "activatedAt": "2026-01-15T10:00:00Z",
  "expiresAt": "2026-02-15T10:00:00Z",
  "autoRenew": true,
  "createdAt": "2026-01-15T09:45:00Z"
}
```

---

## üìã Audit Logs Collection

**Path:** `/audit_logs/{auditId}`

```typescript
interface AuditLog {
  id: string;
  userId: string;
  
  // Period
  weekStartDate: Timestamp;
  weekEndDate: Timestamp;
  
  // Analysis
  totalWorkouts: number;
  totalHours: number;
  averageDifficulty: 0-5;
  
  // AI Findings
  progressingMuscles: string[];
  stagnantMuscles: string[];
  injuryRisks: string[];
  recoveryNeeded: boolean;
  
  // Recommendations
  suggestions: string[];
  nextWeekFocus?: string;
  
  // Metadata
  generatedAt: Timestamp;
  reviewed: boolean;
  reviewedAt?: Timestamp;
}
```

### Example
```json
{
  "id": "audit_789",
  "userId": "user_123abc",
  "weekStartDate": "2026-01-12T00:00:00Z",
  "weekEndDate": "2026-01-19T23:59:59Z",
  "totalWorkouts": 4,
  "totalHours": 3.5,
  "averageDifficulty": 4,
  "progressingMuscles": ["chest", "triceps"],
  "stagnantMuscles": ["legs"],
  "injuryRisks": ["shoulder fatigue"],
  "recoveryNeeded": true,
  "suggestions": [
    "Add leg day this week",
    "Reduce upper body volume",
    "Take 1-2 rest days"
  ],
  "nextWeekFocus": "Lower body focus",
  "generatedAt": "2026-01-19T18:00:00Z"
}
```

---

## üìà How to Save & Fetch Data

### Install Firestore Package
```bash
npm install firebase
```

### Save a Workout

```typescript
import { collection, addDoc, Timestamp } from 'firebase/firestore';
import { db } from '../auth/firebase-config';
import { useAuth } from '../auth/useAuth';

export const saveWorkout = async (workout: Workout) => {
  const { user } = useAuth();
  
  try {
    const workoutRef = collection(db, 'users', user.id, 'workouts');
    const docRef = await addDoc(workoutRef, {
      ...workout,
      userId: user.id,
      createdAt: Timestamp.now(),
      updatedAt: Timestamp.now(),
    });
    
    return docRef.id;
  } catch (error) {
    console.error('Error saving workout:', error);
    throw error;
  }
};
```

### Fetch User's Workouts

```typescript
import { collection, query, where, getDocs } from 'firebase/firestore';

export const getUserWorkouts = async (userId: string) => {
  try {
    const q = query(
      collection(db, 'users', userId, 'workouts'),
      // Optional: order by date
    );
    
    const snapshot = await getDocs(q);
    const workouts = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));
    
    return workouts;
  } catch (error) {
    console.error('Error fetching workouts:', error);
    throw error;
  }
};
```

### Fetch Weekly Workout History

```typescript
import { collection, query, where, orderBy, getDocs } from 'firebase/firestore';

export const getWeeklyHistory = async (userId: string, weekStart: Date) => {
  const weekEnd = new Date(weekStart.getTime() + 7 * 24 * 60 * 60 * 1000);
  
  try {
    const q = query(
      collection(db, 'users', userId, 'workouts'),
      where('date', '>=', Timestamp.fromDate(weekStart)),
      where('date', '<', Timestamp.fromDate(weekEnd)),
      orderBy('date', 'desc')
    );
    
    const snapshot = await getDocs(q);
    return snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));
  } catch (error) {
    console.error('Error fetching weekly history:', error);
    throw error;
  }
};
```

### Update User Subscription

```typescript
import { doc, updateDoc, Timestamp } from 'firebase/firestore';

export const updateSubscription = async (userId: string, subscription: Partial<Subscription>) => {
  try {
    const userRef = doc(db, 'users', userId);
    await updateDoc(userRef, {
      subscriptionStatus: subscription.status,
      premiumExpiresAt: subscription.expiresAt ? Timestamp.fromDate(subscription.expiresAt) : null,
      updatedAt: Timestamp.now(),
    });
  } catch (error) {
    console.error('Error updating subscription:', error);
    throw error;
  }
};
```

### Real-time Subscription to Workouts

```typescript
import { collection, query, onSnapshot } from 'firebase/firestore';

export const subscribeToWorkouts = (userId: string, callback: (workouts: Workout[]) => void) => {
  const q = query(collection(db, 'users', userId, 'workouts'));
  
  const unsubscribe = onSnapshot(q, (snapshot) => {
    const workouts = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));
    callback(workouts);
  });
  
  return unsubscribe; // Call to stop listening
};
```

---

## üîç Indexing for Performance

Create composite indexes in Firestore for complex queries:

```
Collection: users/{userId}/workouts
Fields:
  - date (Descending)
  - progressiveOverloadStatus (Ascending)

Collection: audit_logs
Fields:
  - userId (Ascending)
  - weekStartDate (Descending)
```

---

## üîê Security Rules

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can only access their own data
    match /users/{userId} {
      allow read, write: if request.auth.uid == userId;
      
      // Workouts subcollection
      match /workouts/{workoutId} {
        allow read, write: if request.auth.uid == userId;
      }
    }
    
    // Public exercise catalog (read-only)
    match /exercises/{exerciseId} {
      allow read: if request.auth != null;
      allow write: if false;
    }
    
    // Subscriptions
    match /subscriptions/{subscriptionId} {
      allow read, write: if request.auth.uid == resource.data.userId;
    }
    
    // Audit logs
    match /audit_logs/{auditId} {
      allow read, write: if request.auth.uid == resource.data.userId;
    }
  }
}
```

---

## üìã Checklist

- [ ] Firestore database created
- [ ] Collections created (users, exercises, subscriptions, audit_logs)
- [ ] Security rules configured
- [ ] Indexes created for complex queries
- [ ] Data models TypeScript interfaces defined
- [ ] Save/fetch functions implemented
- [ ] Real-time listeners set up (if needed)
- [ ] Error handling added
- [ ] User profile linked to auth system

---

## üöÄ Next Steps

1. Implement **weekly audit generation** (scheduled function)
2. Add **data export** functionality
3. Build **analytics dashboard**
4. Create **backup & recovery** system
5. Implement **data retention policies**
